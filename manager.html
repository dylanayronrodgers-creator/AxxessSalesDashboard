<!-- manager.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Manager Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#ffffff;--card:#f6f9fc;--accent:#00a6c2;--text:#0b2b3a;--muted:#6b7c86}
  body{margin:0;background:linear-gradient(180deg,#ffffff 0,#f3f7fb 100%);font-family:Inter,system-ui;color:var(--text)}
  header{display:flex;align-items:center;justify-content:space-between;padding:18px 36px}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(14,30,37,0.06)}
  .logo img{width:56px;height:56px;border-radius:8px}
  .form-row{display:flex;gap:12px;margin-top:12px}
  input,select{padding:12px;border-radius:8px;border:1px solid #d7e2ea;background:white}
  button{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:18px}
  th,td{padding:12px;border-bottom:1px solid #e6eef6}
  .error{color:#c94a4a;margin-top:8px}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px" class="logo"><img src="https://i.ibb.co/1GrhnMc4/images.jpg" alt="logo"><div><div style="font-size:12px;color:var(--muted)">Manager</div><div style="font-weight:700">Manager Dashboard</div></div></div>
  <div><button id="logoutBtn">Logout</button></div>
</header>

<div class="wrap">
  <div class="card">
    <h2>Add Agent</h2>
    <div class="form-row">
      <input id="aName" placeholder="Name">
      <input id="aEmail" placeholder="Email">
      <input id="aPwd" placeholder="Password">
      <select id="aTeam">
        <option value="">Select team</option>
        <option value="1">Sales</option>
        <option value="2">ClientCare</option>
      </select>
      <input id="aTarget" placeholder="Target (R)" type="number" value="0">
      <button id="addAgentBtn">Add</button>
    </div>
    <div id="mgrError" class="error"></div>
  </div>

  <div style="height:18px"></div>

  <div class="card">
    <h2>Agent Performance</h2>
    <div style="display:flex;justify-content:flex-end;gap:12px"><input id="monthPicker" type="month"><button id="downloadCSV">Download CSV</button></div>
    <table>
      <thead><tr><th>Name</th><th>Team</th><th>Target (R)</th><th>Month Sales (R)</th><th>Progress</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="agentsTable"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { supabase } from './supabase-config.js';

const userId = await (async()=>{ try { const s = localStorage.getItem('userId'); if(!s) window.location.href='index.html'; return s;} catch(e){return null}})();
if(!userId) window.location.href='index.html';

const addBtn = document.getElementById('addAgentBtn');
const errorEl = document.getElementById('mgrError');
const agentsTable = document.getElementById('agentsTable');
const monthPicker = document.getElementById('monthPicker');

addBtn.addEventListener('click', async ()=>{
  errorEl.textContent='';
  const name = document.getElementById('aName').value.trim();
  const email = document.getElementById('aEmail').value.trim();
  const password = document.getElementById('aPwd').value.trim();
  const team_id = document.getElementById('aTeam').value || null;
  const target = Number(document.getElementById('aTarget').value || 0);

  if(!name||!email||!password) return errorEl.textContent='Name, email and password required';

  // Call serverless function (Vercel) that uses service_role key to create auth user
  try {
    const res = await const res = await fetch('https://sales-dashboard-axxess.vercel.app/api/add-agent', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ email, password })
    });
    const payload = await res.json();
    if (!res.ok) { errorEl.textContent = payload?.error?.message || JSON.stringify(payload); return; }

    // Insert into agents table with the returned id
    const { error } = await supabase.from('agents').insert({
      id: payload.id,
      name, email, target, sales:0, team_id: team_id ? parseInt(team_id) : null
    });
    if (error) { errorEl.textContent = error.message; return; }
    // clear form and reload
    document.getElementById('aName').value='';document.getElementById('aEmail').value='';document.getElementById('aPwd').value='';
    loadAgents();
  } catch (err) {
    errorEl.textContent = `Unexpected token '<'... error usually means the API function crashed — check Vercel logs. Details: ${err.message}`;
  }
});

async function loadAgents(){
  const { data, error } = await supabase.from('agents').select('id,name,email,target,sales,team_id').order('name');
  if (error) { console.error(error); return; }
  agentsTable.innerHTML = (data||[]).map(a => {
    const monthSales = 0; // placeholder: we compute below by query for selected month (light on CPU in this example)
    const progress = a.target > 0 ? (Number(a.sales||0) / Number(a.target))*100 : 0;
    const status = progress < 30 ? 'At Risk' : progress < 80 ? 'On Track' : 'Ahead';
    return `<tr>
      <td>${a.name}</td>
      <td>${a.team_id || '—'}</td>
      <td>${Number(a.target||0).toLocaleString()}</td>
      <td>${monthSales}</td>
      <td>${progress.toFixed(1)}%</td>
      <td>${status}</td>
      <td><button onclick="deleteAgent('${a.id}')">Delete</button></td>
    </tr>`;
  }).join('');
}

window.deleteAgent = async (id) => {
  if(!confirm('Delete agent?')) return;
  const { error } = await supabase.from('agents').delete().eq('id', id);
  if (error) return alert(error.message);
  loadAgents();
};

document.getElementById('downloadCSV').addEventListener('click', async ()=>{
  // fetch sales for the chosen month (or fallback to current month)
  const month = monthPicker.value || `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
  const start = new Date(month + '-01T00:00:00Z').toISOString();
  const end = new Date(new Date(start).getFullYear(), new Date(start).getMonth()+1, 1).toISOString();

  const { data, error } = await supabase.from('sales_log').select('agent_id,package_type,amount,date').gte('date', start).lt('date', end);
  if (error) return alert(error.message);
  if (!data || data.length===0) return alert('No sales for period');

  // map agent ids to names
  const agentsRes = await supabase.from('agents').select('id,name');
  const names = (agentsRes.data||[]).reduce((m, a)=> (m[a.id]=a.name, m), {});
  const rows = data.map(r => [names[r.agent_id]||r.agent_id, r.package_type, r.amount, r.date]);
  const csv = ['Agent,Package,Amount,Date', ...rows.map(r => r.map(String).map(c => `"${c.replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `sales_${month}.csv`; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await supabase.auth.signOut(); localStorage.clear(); window.location.href='index.html';});

loadAgents();
</script>
</body>
</html>
