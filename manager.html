<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="supabase-config.js"></script>
  <style>
    .panel { padding:20px 0; }
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .table-wrap { margin-top:10px; overflow:auto; }
    .table { min-width:900px; }
    .modal-inner input, .modal-inner select { margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Manager Dashboard</h1>
      <div>
        <button id="logoutBtn" class="logout">Logout</button>
      </div>
    </div>

    <section class="panel glass">
      <div class="controls">
        <button id="addAgentBtn" class="btn">Add Agent</button>
        <button id="downloadBtn" class="btn">Download Sales Report</button>
        <div class="right small">Connected to Supabase</div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead><tr>
            <th>Name</th><th>Email</th><th>Team</th><th>Target (R)</th><th>Sales (R)</th><th>Progress</th><th>Actions</th>
          </tr></thead>
          <tbody id="agentsTbody"></tbody>
        </table>
      </div>

      <div class="chat">
        <h3>Messages</h3>
        <div id="messagesDiv" class="messages"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input id="broadcastInput" class="input" placeholder="Send a message to all agents..." />
          <button id="broadcastBtn" class="btn">Send</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Add Agent Modal -->
  <div id="addAgentModal" class="modal hidden">
    <div class="modal-inner glass" style="padding:18px; width:420px;">
      <h3 style="color:var(--accent); margin-top:0;">Add Agent</h3>
      <form id="addAgentForm">
        <input id="agentName" class="input" placeholder="Full name" required />
        <input id="agentEmail" class="input" placeholder="Email" required />
        <input id="agentPassword" class="input" placeholder="Temporary password" type="password" required />
        <select id="agentTeam" class="input" required>
          <option value="">Select team</option>
          <option value="Sales">Sales</option>
          <option value="ClientCare">ClientCare</option>
        </select>
        <div style="display:flex; gap:10px;">
          <button type="submit" class="btn">Add</button>
          <button type="button" id="cancelAdd" class="btn" style="background:transparent;border:2px solid var(--accent);color:var(--accent);">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const logoutBtn = document.getElementById('logoutBtn');
    const addAgentBtn = document.getElementById('addAgentBtn');
    const addAgentModal = document.getElementById('addAgentModal');
    const cancelAdd = document.getElementById('cancelAdd');
    const addAgentForm = document.getElementById('addAgentForm');
    const agentsTbody = document.getElementById('agentsTbody');
    const broadcastInput = document.getElementById('broadcastInput');
    const broadcastBtn = document.getElementById('broadcastBtn');
    const messagesDiv = document.getElementById('messagesDiv');
    const downloadBtn = document.getElementById('downloadBtn');

    const user = JSON.parse(localStorage.getItem('user'));
    const role = localStorage.getItem('role');

    if (!user || role !== 'manager') {
      window.location.href = 'index.html';
    }

    // Load agents
    async function loadAgents(){
      const { data, error } = await supabase.from('agents').select('*').order('name');
      if (error) { console.error(error); return; }
      agentsTbody.innerHTML = '';
      data.forEach(a => {
        const percent = a.target > 0 ? ((a.sales / a.target) * 100).toFixed(1) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.name}</td>
          <td>${a.email}</td>
          <td>${a.team || ''}</td>
          <td><input class="input-target" data-id="${a.id}" value="${a.target || 0}" /></td>
          <td>${a.sales || 0}</td>
          <td>${percent}%</td>
          <td><button class="btn deleteBtn" data-id="${a.id}">Delete</button></td>
        `;
        agentsTbody.appendChild(tr);
      });
    }

    // Subscriptions: agents & messages
    supabase.channel('agents-ch').on('postgres_changes', { event: '*', schema:'public', table:'agents' }, loadAgents).subscribe();
    supabase.channel('messages-ch').on('postgres_changes', { event: '*', schema:'public', table:'messages' }, loadMessages).subscribe();

    await loadAgents();
    await loadMessages();

    // Modal controls
    addAgentBtn.addEventListener('click', ()=> addAgentModal.classList.remove('hidden'));
    cancelAdd.addEventListener('click', ()=> addAgentModal.classList.add('hidden'));

    // Add agent - uses serverless /api/create-user to create auth user safely
    addAgentForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('agentName').value.trim();
      const email = document.getElementById('agentEmail').value.trim();
      const password = document.getElementById('agentPassword').value.trim();
      const team = document.getElementById('agentTeam').value;

      if(!name || !email || !password || !team) { alert('Fill all'); return; }

      try {
        // Create auth user server-side (recommended)
        const resp = await fetch('/api/create-user', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const j = await resp.json();
        if (j.error) throw new Error(j.error.message || JSON.stringify(j.error));

        // Insert agent row (use returned id if available)
        const id = j.id || undefined;
        const payload = { name, email, team, target:0, sales:0 };
        if(id) payload.id = id;

        const { error } = await supabase.from('agents').insert([payload]);
        if (error) throw error;

        addAgentModal.classList.add('hidden');
        addAgentForm.reset();
        loadAgents();
      } catch(err){
        alert('Add agent failed: ' + (err.message||err));
        console.error(err);
      }
    });

    // Delete & target update handlers (delegated)
    document.body.addEventListener('click', async (e) => {
      if(e.target.classList.contains('deleteBtn')){
        const id = e.target.dataset.id;
        if(!confirm('Delete agent?')) return;
        const { error } = await supabase.from('agents').delete().eq('id', id);
        if (error) return alert('Delete failed: ' + error.message);
        loadAgents();
      }
    });

    document.body.addEventListener('change', async (e) => {
      if (e.target.classList.contains('input-target')) {
        const id = e.target.dataset.id;
        const value = Number(e.target.value||0);
        const { error } = await supabase.from('agents').update({ target: value }).eq('id', id);
        if (error) alert('Update failed: ' + error.message);
      }
    });

    // Messages
    async function loadMessages(){
      const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending:true });
      if (error) { console.error(error); return; }
      messagesDiv.innerHTML = '';
      data.forEach(m => {
        const div = document.createElement('div');
        div.className = 'msg' + (m.sender_role === 'agent' ? ' agent' : '');
        div.innerHTML = `<strong>${m.sender}</strong><div class="small">${new Date(m.created_at).toLocaleString()}</div><div>${m.text}</div>`;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    broadcastBtn.addEventListener('click', async () => {
      const text = broadcastInput.value.trim();
      if(!text) return;
      const { error } = await supabase.from('messages').insert([{ sender: user.email, sender_role: 'manager', text, created_at: new Date().toISOString() }]);
      if (error) alert('Send failed: ' + error.message);
      else { broadcastInput.value=''; loadMessages(); }
    });

    // download CSV
    downloadBtn.addEventListener('click', async () => {
      const { data, error } = await supabase.from('sales_log').select('agent_id, package_type, amount, date');
      if (error || !data) return alert('Report error');
      const csv = [Object.keys(data[0]).join(',')].concat(data.map(r => Object.values(r).join(','))).join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sales_report.csv'; a.click();
    });

    // logout
    logoutBtn.addEventListener('click', async ()=> {
      await supabase.auth.signOut();
      localStorage.clear();
      window.location.href = 'index.html';
    });

  </script>
</body>
</html>


</body>
</html>
