 <!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="supabase-config.js"></script>
</head>
<body class="dashboard">
  <header>
    <h1>Manager Dashboard</h1>
    <button id="logoutBtn">Logout</button>
  </header>

  <main>
    <section class="actions">
      <h2>Manage Agents</h2>
      <button id="addAgentBtn">Add Agent</button>
      <button id="downloadReportBtn">Download Sales Report</button>
    </section>

```
<section class="agent-table">
  <table id="agentsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Team</th>
        <th>Target (R)</th>
        <th>Sales (R)</th>
        <th>Progress</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section class="messages">
  <h2>Messages</h2>
  <textarea id="broadcastMsg" placeholder="Send message to all agents..."></textarea>
  <button id="sendBroadcast">Send</button>
  <div id="messagesList" class="message-list"></div>
</section>
```

  </main>

  <!-- Modal for adding/editing agent -->

  <div id="agentModal" class="modal hidden">
    <div class="modal-content">
      <h3 id="modalTitle">Add Agent</h3>
      <label>Name</label>
      <input id="agentNameInput" type="text" required>
      <label>Email</label>
      <input id="agentEmailInput" type="email" required>
      <label>Password</label>
      <input id="agentPasswordInput" type="password" required>
      <label>Team</label>
      <select id="agentTeamSelect">
        <option value="1">Sales</option>
        <option value="2">ClientCare</option>
      </select>
      <label>Target (R)</label>
      <input id="agentTargetInput" type="number" value="0">
      <div class="modal-buttons">
        <button id="saveAgentBtn">Save</button>
        <button id="cancelAgentBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) window.location.href = 'index.html';

    const tableBody = document.querySelector('#agentsTable tbody');
    const modal = document.getElementById('agentModal');
    const modalTitle = document.getElementById('modalTitle');

    let editingAgentId = null;

    // Load all agents
    async function loadAgents() {
      const { data, error } = await supabase.from('agents').select('*, teams(name)').order('name');
      if (error) return console.error(error);
      renderAgents(data);
    }

    function renderAgents(agents) {
      tableBody.innerHTML = agents.map(agent => {
        const percent = agent.target > 0 ? ((agent.sales / agent.target) * 100).toFixed(1) : 0;
        return `
          <tr>
            <td>${agent.name}</td>
            <td>${agent.email}</td>
            <td>${agent.teams?.name || ''}</td>
            <td><input type='number' value='${agent.target}' onchange='updateTarget("${agent.id}", this.value)'/></td>
            <td>${agent.sales}</td>
            <td>${percent}%</td>
            <td>
              <button onclick='deleteAgent("${agent.id}")'>Delete</button>
            </td>
          </tr>`;
      }).join('');
    }

    window.updateTarget = async (agentId, newTarget) => {
      const { error } = await supabase.from('agents').update({ target: parseFloat(newTarget) }).eq('id', agentId);
      if (error) alert('Error updating target: ' + error.message);
    };

    window.deleteAgent = async (agentId) => {
      if (!confirm('Are you sure you want to delete this agent?')) return;
      const { error } = await supabase.from('agents').delete().eq('id', agentId);
      if (error) alert('Error deleting agent: ' + error.message);
      else loadAgents();
    };

    // Add Agent modal controls
    document.getElementById('addAgentBtn').addEventListener('click', () => {
      editingAgentId = null;
      modalTitle.textContent = 'Add Agent';
      modal.classList.remove('hidden');
    });

    document.getElementById('cancelAgentBtn').addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    document.getElementById('saveAgentBtn').addEventListener('click', async () => {
      const name = document.getElementById('agentNameInput').value;
      const email = document.getElementById('agentEmailInput').value;
      const password = document.getElementById('agentPasswordInput').value;
      const team_id = parseInt(document.getElementById('agentTeamSelect').value);
      const target = parseFloat(document.getElementById('agentTargetInput').value);

      // Call secure backend endpoint to create auth user
      const resp = await fetch('/api/create-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const newUser = await resp.json();

      if (newUser.error) {
        alert('Error creating user: ' + newUser.error.message);
        return;
      }

      const { error } = await supabase.from('agents').insert({ id: newUser.id, name, email, team_id, target });
      if (error) alert('Error saving agent: ' + error.message);
      else {
        alert('Agent added successfully!');
        modal.classList.add('hidden');
        loadAgents();
      }
    });

    // Broadcast message
    document.getElementById('sendBroadcast').addEventListener('click', async () => {
      const content = document.getElementById('broadcastMsg').value;
      if (!content) return;
      const { error } = await supabase.from('messages').insert({ from_id: user.id, content, to_id: null });
      if (error) alert('Error sending broadcast: ' + error.message);
      else {
        document.getElementById('broadcastMsg').value = '';
        alert('Message sent!');
      }
    });

    // Download CSV report
    document.getElementById('downloadReportBtn').addEventListener('click', async () => {
      const { data, error } = await supabase.from('sales_log').select('agent_id, package_type, amount, date');
      if (error || !data) return alert('Error fetching report');

      const csv = [Object.keys(data[0]).join(',')]
        .concat(data.map(r => Object.values(r).join(',')))
        .join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sales_report.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      localStorage.clear();
      window.location.href = 'index.html';
    });

    loadAgents();
  </script>

</body>
</html>
