<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agent Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="supabase-config.js"></script>
  <style>
    .stats-row{display:flex;gap:12px;margin-bottom:14px}
    .stat{flex:1;padding:16px;border-radius:12px;background:rgba(255,255,255,0.02);text-align:center}
    .action-row{display:flex;gap:12px;align-items:center}
    .reply-row{display:flex;gap:12px;margin-top:12px}
    #saleMsg{margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <img src="https://i.ibb.co/1GrhnMc4/images.jpg" alt="Axxess Logo" class="dashboard-logo" onclick="location.href='index.html'">
        <div><div class="small">Agent</div><div style="font-weight:700;color:#dff">Agent Dashboard</div></div>
      </div>
      <div>
        <button id="logoutBtn" class="btn ghost">Logout</button>
      </div>
    </div>

    <div class="card">
      <div class="stats-row">
        <div class="stat"><div class="small">Monthly Target (R)</div><div id="targetVal">R0</div></div>
        <div class="stat"><div class="small">Total Sales (R)</div><div id="salesVal">R0</div></div>
        <div class="stat"><div class="small">Progress</div><div id="progressVal">0%</div></div>
      </div>

      <div class="card" style="padding:14px">
        <div class="action-row">
          <select id="packageType" class="input" style="min-width:320px;">
            <option value="">Select package</option>
            <option value="Fibre Uncapped 50Mbps">Fibre Uncapped 50Mbps - R599</option>
            <option value="LTE 50GB">LTE 50GB - R299</option>
            <option value="VoIP Activation">VoIP Activation - R99</option>
            <option value="Other">Other</option>
          </select>
          <input id="amountInput" class="input" placeholder="Amount (R)" type="number" min="0" step="0.01">
          <button id="logSaleBtn" class="btn">Add Sale</button>
        </div>
        <div id="saleMsg" class="small"></div>
      </div>

      <div style="margin-top:16px">
        <h3>Messages</h3>
        <div id="messagesArea" class="messages"></div>
        <div class="reply-row">
          <input id="replyInput" class="input" placeholder="Reply to manager...">
          <button id="replyBtn" class="btn">Send</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { supabase } from './supabase-config.js';

  // require session
  const { data: sdata } = await supabase.auth.getSession();
  const session = sdata?.session;
  if (!session) { location.href='index.html'; throw 'Not logged in'; }
  const user = session.user;

  const targetEl = document.getElementById('targetVal');
  const salesEl = document.getElementById('salesVal');
  const progressEl = document.getElementById('progressVal');
  const packageTypeEl = document.getElementById('packageType');
  const amountEl = document.getElementById('amountInput');
  const logSaleBtn = document.getElementById('logSaleBtn');
  const saleMsg = document.getElementById('saleMsg');
  const messagesArea = document.getElementById('messagesArea');
  const replyInput = document.getElementById('replyInput');
  const replyBtn = document.getElementById('replyBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  let agentRow = null;

  async function loadAgent(){
    const { data, error } = await supabase.from('agents').select('*').eq('email', user.email).single();
    if (error) { console.error(error); saleMsg.textContent='Unable to load agent'; return; }
    agentRow = data;
    targetEl.textContent = `R${Number(agentRow.target||0).toLocaleString()}`;
    salesEl.textContent = `R${Number(agentRow.sales||0).toLocaleString()}`;
    const pct = agentRow.target && Number(agentRow.target) > 0 ? Math.min(100,(Number(agentRow.sales||0)/Number(agentRow.target))*100) : 0;
    progressEl.textContent = `${pct.toFixed(1)}%`;
  }

  await loadAgent();

  // Realtime subscriptions
  const agentFilter = `id=eq.${agentRow?.id || 'null'}`;
  supabase.channel(`agent-ch-${user.id}`)
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'agents', filter: agentFilter }, ()=>loadAgent())
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'sales_log' }, payload => {
      if (payload?.new?.agent_id === agentRow?.id) loadAgent();
    })
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages' }, ()=>loadMessages())
    .subscribe();

  async function loadMessages(){
    // messages where broadcast (to_id IS NULL) or to/from this agent
    const { data, error } = await supabase.from('messages').select('*').or(`to_id.is.null,to_id.eq.${agentRow.id},from_id.eq.${agentRow.id}`).order('timestamp', { ascending: true });
    if (error) { console.error(error); return; }
    messagesArea.innerHTML = '';
    (data||[]).forEach(m => {
      const d = document.createElement('div'); d.className='msg';
      const who = m.from_id === agentRow.id ? 'You' : (m.from_id ? 'Manager' : 'Manager');
      d.innerHTML = `<div style="font-weight:700">${who}</div><div class="small">${new Date(m.timestamp).toLocaleString()}</div><div style="margin-top:6px">${m.content}</div>`;
      messagesArea.appendChild(d);
    });
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }
  await loadMessages();

  // log sale
  logSaleBtn.addEventListener('click', async ()=>{
    saleMsg.textContent=''; logSaleBtn.disabled = true; logSaleBtn.textContent='Logging...';
    const pkg = packageTypeEl.value, amount = Number(amountEl.value||0);
    if (!pkg) { saleMsg.textContent='Select a package'; logSaleBtn.disabled=false; logSaleBtn.textContent='Add Sale'; return; }
    if (!amount || amount <= 0) { saleMsg.textContent='Enter a valid amount'; logSaleBtn.disabled=false; logSaleBtn.textContent='Add Sale'; return; }
    try {
      const { error: insertErr } = await supabase.from('sales_log').insert([{ agent_id: agentRow.id, package_type: pkg, amount, date: new Date().toISOString() }]);
      if (insertErr) throw insertErr;
      // call secure RPC to increment agents.sales
      const { error: rpcErr } = await supabase.rpc('increment_agent_sales_secure', { agent_uuid: agentRow.id, add_amount: amount });
      if (rpcErr) console.warn('RPC error', rpcErr);
      await loadAgent();
      saleMsg.style.color='lightgreen'; saleMsg.textContent = `Sale logged: ${pkg} R${amount}`;
      packageTypeEl.selectedIndex = 0; amountEl.value='';
    } catch (err) {
      console.error(err);
      saleMsg.style.color='salmon';
      saleMsg.textContent = 'Error logging sale: ' + (err.message || JSON.stringify(err));
    } finally {
      logSaleBtn.disabled=false; logSaleBtn.textContent='Add Sale';
    }
  });

  // reply
  replyBtn.addEventListener('click', async ()=>{
    const text = replyInput.value.trim(); if (!text) return;
    const { error } = await supabase.from('messages').insert([{ content: text, from_id: agentRow.id, to_id: null, timestamp: new Date().toISOString() }]);
    if (error) return alert('Reply failed: '+error.message);
    replyInput.value=''; loadMessages();
  });

  logoutBtn.addEventListener('click', async ()=>{ await supabase.auth.signOut(); localStorage.clear(); location.href='index.html'; });
</script>
</body>
</html>
