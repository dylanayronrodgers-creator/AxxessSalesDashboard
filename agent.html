<!-- agent.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agent Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#ffffff;--card:#f5f8fb;--accent:#00c6d4;--text:#0b2b3a;--muted:#6b7c86}
    body{margin:0;background:linear-gradient(180deg,#fff #f2f6fb);color:var(--text);font-family:Inter,system-ui}
    header{display:flex;align-items:center;justify-content:space-between;padding:20px 40px}
    .logo{display:flex;gap:12px;align-items:center}
    .logo img{width:56px;height:56px;border-radius:8px}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);padding:22px;border-radius:12px;box-shadow:0 6px 20px rgba(14,30,37,0.06)}
    .kpis{display:flex;gap:14px}
    .kpi{flex:1;padding:18px;border-radius:10px;background:white;text-align:center}
    .label{color:var(--muted);font-size:13px}
    .value{font-weight:600;font-size:20px;margin-top:8px}
    .row{display:flex;gap:12px;margin-top:14px}
    select,input{padding:12px;border-radius:8px;border:1px solid #d7e2ea;background:white}
    button{background:var(--accent);color:white;padding:10px 16px;border-radius:10px;border:none;cursor:pointer}
    .messages{margin-top:18px}
    .msg{background:#fff;border-radius:10px;padding:12px;margin-bottom:10px}
    .error{color:#c94a4a;margin-top:10px}
  </style>
</head>
<body>
<header>
  <div class="logo"><img src="https://i.ibb.co/1GrhnMc4/images.jpg" alt="logo"><div><div style="font-size:12px;color:var(--muted)">Agent</div><div style="font-weight:700">Agent Dashboard</div></div></div>
  <div><button id="logoutBtn">Logout</button></div>
</header>

<div class="wrap">
  <div class="card">
    <div class="kpis">
      <div class="kpi"><div class="label">Monthly Target (R)</div><div id="targetVal" class="value">R0</div></div>
      <div class="kpi"><div class="label">Total Sales (R)</div><div id="salesVal" class="value">R0</div></div>
      <div class="kpi"><div class="label">Progress</div><div id="progressVal" class="value">0.0%</div></div>
    </div>

    <div class="row" style="margin-top:18px">
      <select id="package">
        <option value="Fibre Uncapped 50Mbps|599">Fibre Uncapped 50Mbps - R599</option>
        <option value="LTE 50GB|299">LTE 50GB - R299</option>
        <option value="5G Starter|379">5G Starter - R379</option>
        <option value="VoIP Activation|99">VoIP Activation - R99</option>
      </select>
      <input id="amount" type="number" value="599" style="width:150px"/>
      <button id="addSaleBtn">Add Sale</button>
    </div>

    <div id="error" class="error" role="alert"></div>

    <div class="messages">
      <h3>Messages</h3>
      <div id="messagesList"></div>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <input id="replyText" placeholder="Reply to manager..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #d7e2ea"/>
        <button id="sendReply">Send</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from './supabase-config.js';
const userId = localStorage.getItem('userId');
if(!userId) window.location.href = 'index.html';

const targetEl = document.getElementById('targetVal');
const salesEl = document.getElementById('salesVal');
const progressEl = document.getElementById('progressVal');
const errorEl = document.getElementById('error');
const messagesList = document.getElementById('messagesList');

let agentData = null;

async function loadAgent(){
  const { data, error } = await supabase.from('agents').select('*').eq('id', userId).single();
  if (error) { errorEl.textContent = error.message; return; }
  agentData = data;
  targetEl.textContent = `R${Number(agentData.target||0).toLocaleString()}`;
  salesEl.textContent = `R${Number(agentData.sales||0).toLocaleString()}`;
  const pct = agentData.target > 0 ? ((Number(agentData.sales||0) / Number(agentData.target)) * 100) : 0;
  progressEl.textContent = `${pct.toFixed(1)}%`;
}

async function loadMessages(){
  const { data } = await supabase.from('messages').select('*').or(`to_id.eq.${userId},to_id.is.null`).order('timestamp',{ascending:false});
  messagesList.innerHTML = (data||[]).map(m => `<div class="msg"><div style="font-weight:600">${m.from_id === userId ? 'You':'Manager'}</div><div style="font-size:12px;color:#6b7c86">${new Date(m.timestamp).toLocaleString()}</div><div style="margin-top:6px">${m.content}</div></div>`).join('') || '<div>No messages</div>';
}

document.getElementById('package').addEventListener('change', (e)=>{
  const parts = e.target.value.split('|');
  document.getElementById('amount').value = parts[1] || '';
});

document.getElementById('addSaleBtn').addEventListener('click', async ()=>{
  errorEl.textContent = '';
  const pkg = document.getElementById('package').value.split('|')[0];
  const amount = Number(document.getElementById('amount').value || 0);
  if(!amount || amount <=0) { errorEl.textContent='Enter a valid amount'; return; }

  // insert sales_log row (RLS policy allows agent to insert their own rows)
  const { error: insertError } = await supabase.from('sales_log').insert({
    agent_id: userId,
    package_type: pkg,
    amount
  });

  if (insertError) {
    errorEl.textContent = `Error logging sale: ${insertError.message}`;
    return;
  }

  // Call secure RPC to increment agents.sales (server-side security definer)
  const { error: rpcError } = await supabase.rpc('increment_agent_sales_secure', { agent_uuid: userId, add_amount: amount });
  if (rpcError) {
    errorEl.textContent = `Error incrementing agent sales: ${rpcError.message}`;
    return;
  }

  // refresh
  await loadAgent();
});

document.getElementById('sendReply').addEventListener('click', async ()=>{
  const text = document.getElementById('replyText').value.trim();
  if(!text) return;
  const { error } = await supabase.from('messages').insert({
    content: text,
    from_id: userId,
    to_id: null -- // broadcast to manager for now
  });
  if(error) { errorEl.textContent = error.message; return; }
  document.getElementById('replyText').value='';
  await loadMessages();
});

// Real-time: refresh on new messages or agent update
supabase.channel('agent-updates')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload=> loadMessages())
  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'agents', filter: `id=eq.${userId}` }, payload=> loadAgent())
  .subscribe();

document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await supabase.auth.signOut(); localStorage.clear(); window.location.href='index.html';});

loadAgent();
loadMessages();
</script>
</body>
</html>
