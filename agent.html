<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Agent Dashboard</title><link rel="stylesheet" href="styles.css"></head>
<body>
<header class="card logo-row">
  <img src="https://i.ibb.co/1GrhnMc4/images.jpg" alt="logo" class="logo-img">
  <div><div style="font-size:12px;color:var(--muted)">Agent</div><div style="font-weight:700">Agent Dashboard</div></div>
  <div style="margin-left:auto"><button id="logoutBtn">Logout</button></div>
</header>

<main class="wrap">
  <section class="card">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <div>Monthly Target (R)</div><div id="target" style="font-weight:700">R0</div>
      </div>
      <div style="flex:1">
        <div>Total Sales (R)</div><div id="sales" style="font-weight:700">R0</div>
      </div>
      <div style="flex:1">
        <div>Progress</div><div id="progress" style="font-weight:700">0.0%</div>
      </div>
    </div>
    <div style="height:12px"></div>
    <div class="form-row">
      <select id="package"><option>Fibre Uncapped 50Mbps - R599</option></select>
      <input id="amount" value="599" type="number">
      <button id="addSaleBtn">Add Sale</button>
    </div>
    <div id="saleError" class="error"></div>
  </section>

  <section class="card">
    <h3>Messages</h3>
    <div id="messages"></div>
    <div style="height:8px"></div>
    <div class="form-row"><input id="reply" placeholder="Reply to manager..."><button id="sendMsg">Send</button></div>
  </section>
</main>

<script type="module">
import {{ supabase }} from './supabase-config.js';
const logoutBtn = document.getElementById('logoutBtn');
logoutBtn.addEventListener('click', async ()=>{{ await supabase.auth.signOut(); localStorage.clear(); window.location.href='index.html'; }});

async function loadProfile(){{
  const user = supabase.auth.getUser ? (await supabase.auth.getUser()).data.user : null;
  // fallback to localStorage
  const uid = localStorage.getItem('userId') || (user && user.id);
  if(!uid) return window.location.href='index.html';
  const {{ data }} = await supabase.from('agents').select('*').eq('id', uid).single();
  if(data){{
    document.getElementById('target').textContent = 'R' + (data.target||0).toLocaleString();
    document.getElementById('sales').textContent = 'R' + (data.sales||0).toLocaleString();
    const prog = data.target ? ((data.sales||0)/data.target)*100 : 0;
    document.getElementById('progress').textContent = prog.toFixed(1) + '%';
  }}
}}
loadProfile();
</script>
</body>
</html>
