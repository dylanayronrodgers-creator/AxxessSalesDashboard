<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agent Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="supabase-config.js"></script>
  <style>
    .stats-grid{ display:flex; gap:12px; align-items:center; }
    .stat { padding:12px; border-radius:10px; background:rgba(255,255,255,0.03); width:180px; text-align:center; }
    .sale-row{ margin-top:12px; display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Agent Dashboard</h1>
      <div><button id="logoutBtn" class="logout">Logout</button></div>
    </div>

    <section class="panel glass">
      <div class="stats-grid">
        <div class="stat">
          <div class="small">Target (R)</div><div id="targetVal">0</div>
        </div>
        <div class="stat">
          <div class="small">Sales (R)</div><div id="salesVal">0</div>
        </div>
        <div class="stat">
          <div class="small">Progress</div><div id="progressVal">0%</div>
        </div>
      </div>

      <div class="sale-row">
        <input id="saleInput" class="input" type="number" placeholder="Amount (R)" />
        <button id="addSaleBtn" class="btn">Add Sale</button>
      </div>

      <div class="chat">
        <h3>Messages</h3>
        <div id="messagesArea" class="messages"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input id="replyInput" class="input" placeholder="Reply to manager..." />
          <button id="replyBtn" class="btn">Send</button>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { supabase } from './supabase-config.js';

    const user = JSON.parse(localStorage.getItem('user'));
    const role = localStorage.getItem('role');
   if (role !== 'agent') {
  // don’t redirect instantly — wait to confirm session
  const { data } = await supabase.auth.getSession();
  if (!data?.session) window.location.href = 'index.html';
}


    const targetVal = document.getElementById('targetVal');
    const salesVal = document.getElementById('salesVal');
    const progressVal = document.getElementById('progressVal');
    const saleInput = document.getElementById('saleInput');
    const addSaleBtn = document.getElementById('addSaleBtn');
    const messagesArea = document.getElementById('messagesArea');
    const replyInput = document.getElementById('replyInput');
    const replyBtn = document.getElementById('replyBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    let agent;

    async function loadAgent(){
      const { data, error } = await supabase.from('agents').select('*').eq('email', user.email).single();
      if (error) { console.error(error); return; }
      agent = data;
      targetVal.textContent = (agent.target||0).toLocaleString();
      salesVal.textContent = (agent.sales||0).toLocaleString();
      const pct = agent.target>0 ? Math.min(100, (agent.sales/agent.target*100)).toFixed(1) : 0;
      progressVal.textContent = pct + '%';
    }

    await loadAgent();

    supabase.channel('agent-ch-'+user.id)
      .on('postgres_changes', { event:'UPDATE', schema:'public', table:'agents', filter:`email=eq.${user.email}` }, loadAgent)
      .subscribe();

    // Add sale -> insert to sales_log then update agents.sales
    addSaleBtn.addEventListener('click', async () => {
      const amount = Number(saleInput.value || 0);
      if (!amount || amount <= 0) return alert('Enter a valid amount');
      // insert into sales_log
      const { error: e1 } = await supabase.from('sales_log').insert([{ agent_id: agent.id, package_type:'Manual', amount, date: new Date().toISOString() }]);
      if (e1) return alert('Error logging sale: ' + e1.message);
      // update agent total sales (trigger prevents decrease)
      const newSales = Number(agent.sales||0) + amount;
      const { error: e2 } = await supabase.from('agents').update({ sales: newSales }).eq('id', agent.id);
      if (e2) return alert('Error updating agent: ' + e2.message);
      saleInput.value='';
      await loadAgent();
    });

    // Messages
    async function loadMessages(){
      const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending:true });
      if (error) { console.error(error); return; }
      messagesArea.innerHTML = '';
      data.forEach(m => {
        const d = document.createElement('div');
        d.className = 'msg' + (m.sender_role === 'agent' ? ' agent' : '');
        d.innerHTML = `<strong>${m.sender}</strong><div class="small">${new Date(m.created_at).toLocaleString()}</div><div>${m.text}</div>`;
        messagesArea.appendChild(d);
      });
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    await loadMessages();
    supabase.channel('messages-ch').on('postgres_changes', { event:'*', schema:'public', table:'messages' }, loadMessages).subscribe();

    replyBtn.addEventListener('click', async () => {
      const text = replyInput.value.trim();
      if(!text) return;
      const { error } = await supabase.from('messages').insert([{ sender: user.email, sender_role:'agent', text, created_at: new Date().toISOString() }]);
      if (error) return alert('Send failed: ' + error.message);
      replyInput.value='';
      loadMessages();
    });

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      localStorage.clear();
      window.location.href = 'index.html';
    });

  </script>
</body>
</html>
