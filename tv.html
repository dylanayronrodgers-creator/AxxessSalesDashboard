<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Axxess Live Sales â€” TV</title>
  <link rel="stylesheet" href="styles.css">
  <script type="module" src="supabase-config.js"></script>
  <style>
    #container{max-width:1400px;margin:18px auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:18px}
    .card{padding:20px}
    .clock{color:#bfe;text-align:center;margin-bottom:12px}
    .footer-msg{color:var(--accent);text-align:center;margin-top:28px;font-weight:700}
  </style>
</head>
<body>
  <div class="container" style="max-width:1300px;margin:12px auto;">
    <div style="text-align:center">
      <img src="https://i.ibb.co/1GrhnMc4/images.jpg" class="dashboard-logo" alt="Axxess Logo">
      <h1 class="h1">Axxess Live Sales</h1>
      <div id="clock" class="clock"></div>
    </div>

    <div id="grid" style="width:100%"></div>
    <div class="footer-msg" id="motivate">Keep hitting those targets ðŸš€</div>
  </div>

<script type="module">
  import { supabase } from './supabase-config.js';
  const grid = document.getElementById('grid');
  const clock = document.getElementById('clock');
  const motivate = document.getElementById('motivate');
  const msgs = ["Keep pushing â€” every sale counts!", "Aim high â€” close those deals!", "Great job team â€” keep the momentum!"];

  function tick(){ const d=new Date(); clock.textContent = d.toLocaleDateString() + ' Â· ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
  setInterval(tick,1000); tick();

  async function loadAll(){
    const { data: teams } = await supabase.from('teams').select('*');
    const tmap = {}; (teams||[]).forEach(t=>tmap[t.id]=t.name);
    const { data: agents } = await supabase.from('agents').select('*').order('team_id').order('name');
    grid.innerHTML='';
    (agents||[]).forEach(a=>{
      const pct = a.target ? Math.min(100,(a.sales||0)/a.target*100).toFixed(1) : 0;
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div style="font-weight:700;color:var(--accent);font-size:20px">${a.name}</div>
        <div class="small">Team: ${tmap[a.team_id]||'â€”'}</div>
        <div style="margin-top:8px">Target: R${Number(a.target||0).toLocaleString()} â€¢ Sales: R${Number(a.sales||0).toLocaleString()}</div>
        <div class="progress" style="margin-top:10px"><div class="fill" style="width:${pct}%"></div></div>
        <div style="margin-top:8px;text-align:center">${pct}% achieved</div>`;
      grid.appendChild(card);
    });
    // rotate motivate
    motivate.textContent = msgs[Math.floor(Math.random()*msgs.length)];
  }

  loadAll(); setInterval(loadAll,7000);

  supabase.channel('tv-ch')
    .on('postgres_changes', { event:'*', schema:'public', table:'agents' }, loadAll)
    .on('postgres_changes', { event:'*', schema:'public', table:'sales_log' }, loadAll)
    .subscribe();
</script>
</body>
</html>
